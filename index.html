<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion Barcode Scanner Sample</title>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-javascript-barcode@9.6.11/dist/dbr.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/dynamsoft-camera-enhancer@3.3.1/dist/dce.js"></script>
    <style>
      .scanner {
        display: none;
        position: absolute;
        left: 0;
        top: 0;
        width: 100%;
        height: 100%;
      }
      .scanner.active {
        display: block;
      }
      .app {
        display: flex;
        flex-direction: column;
        width: calc(100% - 40px);
        padding-left: 20px;
        padding-right: 20px;
      }

      .fullwidth {
        width: 100%;
      }

      table {
        border-collapse: collapse;
      }

      table, th, td {
        border: 1px solid black;
      }

      .resultContainer {
        padding-top: 1em;
      }

      label{
        width:75px;
        display: inline-block;
      }
    </style>
  </head>
  <body>
    <div class="app">
      <h2 class="title">Scan Books to Notion</h2>
      <div class="inputContainer">
        <div>
          <label for="databaseInput">
            Database:
          </label>
          <input type="text" id="databaseInput"/>
        </div>
        <div>
          <label for="tokenInput">
            Token:
          </label>
          <input type="text" class="tokenInput"/>
        </div>
        <div style="padding-top:10px;">
          <button class="scanButton">Scan Barcodes</button>
          <span id="status"></span>
        </div>
      </div>
      
      <div class="fullwidth">
        <div class="resultContainer fullwidth">
          <table class="results fullwidth">
            <tr>
              <th>Cover</th>
              <th>ISBN</th>
              <th>Title</th>
              <th>Action</th>
            </tr>
          </table>
        </div>
      </div>
      <div class="scanner"></div>
    </div>
    <script>
      let reader;
      let enhancer;
      let interval;
      let processing = false;
      window.onload = function() {
        init();
        document.getElementsByClassName("scanButton")[0].addEventListener("click",function(){
          startScan();
        });
      }

      async function init(){
        updateStatus("Initializing...");
        reader = await Dynamsoft.DBR.BarcodeScanner.createInstance();
        await useEAN13Template();
        enhancer = await Dynamsoft.DCE.CameraEnhancer.createInstance();
        enhancer.on("played", (playCallbackInfo) => {
          startProcessingLoop();
        });
        updateStatus("");
        await enhancer.setUIElement(Dynamsoft.DCE.CameraEnhancer.defaultUIElementURL);
        setScanRegion();
        let container = document.getElementsByClassName("scanner")[0];
        container.appendChild(enhancer.getUIElement());
        document.getElementsByClassName("dce-btn-close")[0].onclick = function () {
          stopScan();
        };
      }

      function startScan(){
        if (!enhancer || !reader) {
          alert("Please wait for the initialization of Dynamsoft Barcode Reader");
          return;
        }
        document.getElementsByClassName("scanner")[0].classList.add("active");
        enhancer.open(true);
      }

      function stopScan(){
        stopProcessingLoop();
        enhancer.close(true);
        document.getElementsByClassName("scanner")[0].classList.remove("active");
      }

      function updateStatus(info){
        document.getElementById("status").innerText = info;
      }

      function setScanRegion(){
        enhancer.setScanRegion({
          regionLeft:0,
          regionTop:25,
          regionRight:100,
          regionBottom:55,
          regionMeasuredByPercentage: 1
        });
      }

      async function useEAN13Template() {
        await reader.initRuntimeSettingsWithString(`
        {
          "FormatSpecification": {
            "Name": "defaultFormatParameterForAllBarcodeFormat"
          },
          "ImageParameter": {
            "BarcodeFormatIds": ["BF_EAN_13"],
            "BarcodeFormatIds_2": ["BF2_NULL"],
            "ExpectedBarcodesCount": 1,
            "FormatSpecificationNameArray": [
              "defaultFormatParameterForAllBarcodeFormat"
            ],
            "Name": "default",
            "Timeout": 3000
          },
          "Version": "3.0"
        }`);
      };

      function startProcessingLoop(isBarcode){
        stopProcessingLoop();
        interval = setInterval(captureAndDecode,100); // read barcodes
      }

      function stopProcessingLoop(){
        if (interval) {
          clearInterval(interval);
          interval = undefined;
        }
        processing = false;
      }

      async function captureAndDecode() {
        if (!enhancer || !reader) {
          return
        }
        if (enhancer.isOpen() === false) {
          return;
        }
        if (processing == true) {
          return;
        }
        processing = true; // set decoding to true so that the next frame will be skipped if the decoding has not completed.
        let frame = enhancer.getFrame();
        if (frame) {  
          let results = await reader.decode(frame);
          console.log(results);
          if (results.length > 0) {
            const result = results[0];
          }
          processing = false;
        }
      };
    </script>
  </body>
</html>